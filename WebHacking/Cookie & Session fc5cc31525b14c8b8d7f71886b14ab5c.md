# Cookie & Session

## 쿠키(Cookie)

클라이언트의 IP 주소와 User-Agent는 매번 변경될 수 있는 고유하지 않은 정보일 뿐만 아니라, HTTP 프로토콜의 **Connectionless**와 **Stateless** 특징 때문에 웹 서버는 클라이언트를 기억할 수 없다.

- **Connectionless, Stateless** 특성을 갖는 HTTP에서 상태를 유지하기 위해 **쿠키(Cookie)**가 탄생했다. 쿠키는 Key와 Value 이뤄진 일종의 단위로, 서버가 클라이언트에게 쿠키를 발급하면, 클라이언트는 서버에 요청을 보낼 때마다 쿠키를 같이 전송한다. 서버는 클라이언트의 요청에 포함된 쿠키를 확인해 클라이언트를 구분할 수 있다.
- **Connectionless** : 하나의 요청에 하나의 응답을 한 후 연결을 종료하는 것을 의미함.
- **Stateless :** 통신이 끝난 후 상태 정보를 저장하지 않는 것을 의미한다.

쿠키가 없는 통신은 요청을 보낸 클라이언트가 누군지 모르기 때문에 어떤 클라이언트와 통신하는지 알 수 없다.

그러나 클라이언트가 쿠키를 보내게 되면 서버는 해당 쿠키를 통해 클라이언트를 식별할 수 있게 된다.

### 쿠키 변조

- 쿠키는 클라이언트의 브라우저에 저장되고 요청에 포함되는 정보이다. 따라서 악의적인 클라이언트는 쿠키 정보를 변조해 서버에 요청을 보낼 수 있다. 만약 서버가 쿠키를 별도의 방법으로 검증하지 않는 이상, 공격자는 손쉽게 타 이용자를 사칭해 정보를 빼낼 수 있다.

## 세션(Session)

쿠키에 인증 상태를 저장하지만 클라이언트가 인증 정보를 변조할 수 없게 세션(Session)을 사용함. 세션은 인증 정보를 서버에 저장하고 **해당 데이터에 접근할 수 있는 키(유추할 수 있는 문자열)**를 만들어 클라이언트에 저장하는 방식으로 작동함. 

그 해당 키를 일반적으로 **Session ID**라고 부름. 

- 쿠키는 클라이언트에 세션은 서버에 저장되는 것.
- 공격자가 이용자의 쿠키를 훔칠 수 있으면 세션에 해당하는 이용자의 인증 상태를 훔칠 수 있는데 이것을 **세션 하이재킹(Session Hijacking)**이라고 부른다.

## 동일 출처 정보(Same Origin Policy) - SOP

쿠키에는 민감한 정보가 보관되고, 이는 브라우저 내부에 저장됨. 그리고 브라우저가 접속할 때, 자동으로 쿠키를 헤더에 포함 시켜 요청을 보낸다. 

그러나 사용자가 악의적으로 조작한 페이지에 접속한다면 해당 페이지에서 이용자의 SNS에 요청을 보내 헤더에 웹 서비스 쿠키를 포함 시킬 수 있다. 이렇게 된다면 접속자의 SNS에 글을 올리고, 삭제하고, SNS 메신저를 읽는 것도 가능해진다.

- 이용자가 웹 서비스에 접속할 때, 브라우저는 해당 웹 서비스에서 사용하는 인증 정보인 쿠키를 HTTP요청에 포함 시켜 전달한다.
- 이 때문에 악의적인 페이지가 클라이언트의 권한을 이용해 대상 사이트에 HTTP 요청을 보내고, HTTP 응답 정보를 획득하는 코드를 실행할 수 있다. 따라서 클라이언트의 입장에서는 가져온 데이터를 악의적인 페이지에서 읽을 수 없도록 해야 한다. 이것이 바로 동일 출처 정책인 SOP이다.
- SOP가 브라우저가 가져온 정보의 출처인 오리진 (Origin)을 어떻게 구분할까.
- 오리진은 프로토콜(Protocol, Scheme), 포트(Port), 호스트(Host)로 구성된다. 구성 요소가 모두 일치해야 동일한 오리진이라고 한다.
- SOP에도 구애 받지 않고 외부 출처에 대한 접근을 허용해주는 경우가 존재한다. 예를 들면 이미지나, 자바스크립트, CSS 등의 리소스를 불러오는 <img>, <style>, <script>가 있다.
- 웹 서비스에서 SOP를 완화하여 다른 출처의 데이터를 처리해야 하는 경우도 존재. 예를 들어 특정 포털 서비스가 카페, 블로그, 메일 등 각기 다른 주소로 운영되고 있을 때 각 서비스의 HOST가 다르기 때문에 브라우저는 각 사이트의 오리진이 다르다고 인식한다.
- 위와 같은 상황에서 쓸 수 있는 것이 바로 교차 출처 리소스 공유(Cross Origin Resource Sharing, CORS)이다.

## 교차 출처 리소스 공유(Cross Origin Resource Sharing) - CORS

교차 출처 리소스 공유는 HTTP 헤더에 기반하여 Cross Origin 간에 리소스를 공유하는 방법이다. 발신 측에서 CORS 헤더를 설정해 요청하면, 수신 측에서 헤더를 구분해 정해진 규칙에 맞게 데이터를 가져갈 수 있도록 설정한다.