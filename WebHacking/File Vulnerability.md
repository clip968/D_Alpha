- 파일 공유 서비스를 개발할 때 이용자가 업로드한 파일을 데이터 베이스에 저장하는 것 보다는 서버의 파일 시스템에 저장하는 것이 더 쉽고, 관리 효율도 더 높다.
- 그러나 반대로 임의 파일이 다운로드 되는 취약점이나 악성 웹셸 파일을 업로드 하여 임의 코드를 실행할 수 있는 취약점을 발생 시키기도 한다.
- 파일 업로드와 관련해서 생기는 취약점을 **파일 업로드 취약점(File Upload Vulnerability)** 라고 하며, 반대로 내려 받을 때 발생하는 취약점을 **파일 다운로드 취약점(File Download Vulnerability)** 라고 한다.

## 파일 업로드 취약점 (File Upload Vulnerability)
- 파일 업로드 취약점은 웹 서비스를 통해 이용자의 파일을 서버의 파일 시스템에 업로드 하는 과정에서 발생하는 보안 취약점이며 **이용자가 업로드 될 파일의 이름을 임의로 정할 수 있을 때** 발생한다.
- 파일 이름에 이용자가 입력한 문자열을 그대로 사용하거나, 이용자의 이메일, 닉네임 등을 포함시키는 등의 소스 코드 패턴이 이러한 취약점을 발생 시킬 수 있다.
- 파일 업로드를 허용하는 대개의 서비스는 보안을 위해 특정 디렉터리에만 업로드를 허용한다. 만약 이러한 제약이 없다면 악의적인 이용자가 웹 서버의 소스 코드 나 서버에 있는 중요 파일 시스템 파일을 덮어 쓸 가능성이 존재한다.
- 크게 **Path Traversal**과 **악성 파일 업로드**로 구분된다.

## Path Traversal
- 업로드에 존재하는 위의 제약을 우회하여 임의 디렉터리에 파일을 업로드 할 수 있는 취약점
![[Pasted image 20240501165726.png]]
![[Pasted image 20240501165733.png]]
- 정상적인 업로드와 같은 경우
![[Pasted image 20240501165755.png]]
![[Pasted image 20240501165811.png]]
![[Pasted image 20240501165830.png]]
- Figure 4는  filename 필드를 변조하여 Path Traversal을 수행하는 HTTP 요청이다. **filename**에 **..** 이 포함되어 있으므로 **상위 디렉토리**에 파일이 저장된다.
![[Pasted image 20240501165946.png]]
- 요청을 전송하면 Figure 5와 같이 app.py파일 위치가 같은 디렉토리에 hack.py가 생성된다. 만약 app.py를 덮어쓴다면 서버가 재실행될 때 임의의 파이썬 코드를 실행할 수 있다.

## 악성 파일 업로드
- 이용자가 파일을 업로드 할 때 이를 제대로 검사하지 않아서 발생하는 취약점

### 웹 셸

![[Pasted image 20240501170827.png]]
- 웹 서버는 php, jsp, asp와 같은 확장자의 파일을 Common Gateway InterFace(CGI)로 실행하고, 그 결과를 이용자에게 반환한다.
![[Pasted image 20240501170447.png]]
- Figure 6는 이용자가 요청한 파일의 확장자가 정규표현식 **".+\.ph(p[3457]?|t|tml)$"** 를 만족하면 x-httpd-php로 핸들링하게 하는 Apache 설정 파일이다.
- 많은 웹 서버들이 php파일에 대해 위와 같은 핸들링을 지원한다. 따라서 공격자가 임의의 php 소스 파일을 .php 확장자로 업로드하고, GET 요청을 보낼 수 있다면 CGI에 의해 해당 코드가 실행될 수 있도록 할 수 있다.

### 악의적인 웹 리소스

- 웹 브라우저는 파일의 확장자나 응답의 Content-Type에 따라 요청을 다양하게 처리한다. 만약 요청한 파일의 확장자가 html이거나 반환된 Content-type 헤더가 text/html일 경우 응답은 HTML엔진으로 처리한다.
- 또 파일의 확장자가 png, jpg등의 이미지 확장자이거나 content-type이 image/png일 경우에는 이미지로 랜더링한다.

- 만약 공격자가 서버에 exploit.html을 업로드하고 이에 접근하는 URL이 https://dreamhack.io/uploads/exploit.html 일 경우 브라우저는 이를 HTML로 해석한다. 즉 exploit.html에 악의적인 스크립트를 삽입하면 XSS 공격으로도 이어질 수 있다.
![[Pasted image 20240501170847.png]]
![[Pasted image 20240501171110.png]]
![[Pasted image 20240501172551.png]]![[Pasted image 20240501172606.png]]
